<html>
<script type="text/javascript" src="parser.js"></script>
<script type="text/javascript">
parser.yy.OUTPUT="digraph";
VERBOSE=false;
parser.yy.parseError=function(str,hash){
	console.log("Parsing error:");
	console.log(str);
	console.log(hash);
	cancelVTimer();
	throw new Error(str);
};
//called line by line...
parser.yy.result=function(line){
   if (parsingStarted){
	parsingStarted=false;
	result.value="";
   }
   result.value=result.value+line+"\n";
}
parser.trace=function(x){console.log("TRACE:"+x);}
</script>
<body>
<form name="contact" action="">
    <select id="generator" name="generator" onChange="generatorChanged()">
      <option value="digraph:dot">Graphviz - dot</option>
      <option value="digraph:circo">Graphviz - circo</option>
      <option value="digraph:twopi">Graphviz - twopi</option>
      <option value="digraph:neato">Graphviz - neato</option>
      <option value="digraph:fdp">Graphviz - fdp</option>
      <option value="actdiag">Activity Diagram</option>
      <option value="blockdiag">Block diagram</option>
      <option value="nwdiag">Network diagram</option>
      <option value="seqdiag">Sequence diagram</option>
      <option value="mscgen">MSCGEN</option>
    </select>
    <select id="example" onChange="exampleChanged()">
<option value="state.txt">state.txt</option>
<option value="state10.txt">state10.txt</option>
<option value="state11.txt">state11.txt</option>
<option value="state12.txt">state12.txt</option>
<option value="state13.txt">state13.txt</option>
<option value="state14.txt">state14.txt</option>
<option value="state15.txt">state15.txt</option>
<option value="state16.txt">state16.txt</option>
<option value="state2.txt">state2.txt</option>
<option value="state3.txt">state3.txt</option>
<option value="state4.txt">state4.txt</option>
<option value="state5.txt">state5.txt</option>
<option value="state6.txt">state6.txt</option>
<option value="state7.txt">state7.txt</option>
<option value="state8.txt">state8.txt</option>
<option value="state9.txt">state9.txt</option>
<option value="state_cluster_edge.txt">state_cluster_edge.txt</option>
<option value="state_dual_node.txt">state_dual_node.txt</option>
<option value="state_sequence.txt">state_sequence.txt</option>
    </select>
    <button onClick="visualize(1);return false;">Visualize</button>
    <br/>
    <textarea name="source" id="source" rows="40" cols="40"></textarea>
    <textarea name="result" id="result" rows="40" cols="40"></textarea>
    <img align="top" id="image" src="result.png"/>
	</form>
</body>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
result= document.getElementById("result");
var vtimer = null;
var vdelay=1000;
function reloadImg(id) {
   var obj = document.getElementById(id);
   var src = obj.src;
   var pos = src.indexOf('?');
   if (pos >= 0) {
      src = src.substr(0, pos);
   }
   var date = new Date();
   obj.src = src + '?v=' + date.getTime();
   return false;
}
function visualize(tt){
	var statelang= document.getElementById("result").value;
	var visualizeUrl="visualize.php?visualizer="+getVisualizer();
	$.ajax({
	  type:"POST",
	  async:true,
	  cache:false,
	  url: visualizeUrl,
	  data:statelang,
	  //data: {body:statelang},
          //contentType: "application/json; charset=utf-8",
          //dataType: "json",
	  success: function(msg) {
	    //UseReturnedData(msg.d);
		//alert(msg);
		document.getElementById("image").setAttribute("src",msg);
		reloadImg('image');
    	  },
    	  error: function(err) {
        	alert("ERROR: "+JSON.stringify(err));
	    if (err.status == 200) {
		    ParseResult(err);
	   }else { alert('Error:' + err.responseText + '  Status: ' + err.status); }
    	  }
	});
}
//Get currently selected generator
function getGenerator(){
	var e = document.getElementById("generator");
	var gen=e.options[e.selectedIndex].value;
	if (gen.indexOf(":")>-1)
		return gen.split(":")[0];
	return gen;
}
function getVisualizer(){
	var e = document.getElementById("generator");
	var gen=e.options[e.selectedIndex].value;
	if (gen.indexOf(":")>-1)
		return gen.split(":")[1];
	return gen;
}
function cancelVTimer(){
        if (vtimer) {
            window.clearTimeout(vtimer);
        }
}
function parse(textArea){
	parsingStarted=true;
	delete (parser.yy.GRAPHROOT);
	delete (parser.yy.LINKS);
	delete (parser.yy.OBJECTS);
	parser.yy.OUTPUT=getGenerator();
	parser.parse(textArea.value+"\n");
        cancelVTimer();
        vtimer = window.setTimeout( function() {
            vtimer = null;
            visualize();
        }, vdelay );
}
function generatorChanged()
{
	parse(document.getElementById("source"));
}
function exampleChanged()
{
	//read the example...place to textArea(overwrite)
	var e = document.getElementById("example");
	var doc=e.options[e.selectedIndex].value;
$.ajax({
  url: doc
}).done(function(data) {
	document.getElementById("source").value=data;
	generatorChanged();
});
}

function delayedKeypressCallback(obj, callback, delay) {
    var timer = null;
    var tt=obj;
    obj.onkeypress = function() {
        if (timer) {
            window.clearTimeout(timer);
        }
        timer = window.setTimeout( function() {
            timer = null;
            callback(tt);
        }, delay );
    };
    obj = null;
}
delayedKeypressCallback( document.getElementById("source"), parse, 150 );
delayedKeypressCallback( document.getElementById("result"), visualize, 250 );
</script>
</html>

